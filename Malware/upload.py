import requests
import json
import os
from requests_toolbelt import MultipartEncoder, MultipartEncoderMonitor
from tqdm import tqdm

# --- é…ç½®åŒº ---
url = "http://10.129.9.52:8002/api/upload"
model_file_path = "malware_classifier.pth"

# æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
if not os.path.exists(model_file_path):
    print(f"âŒ æ‰¾ä¸åˆ°æ–‡ä»¶: {model_file_path}")
    exit()

# è·å–æ–‡ä»¶å¤§å°ç”¨äºè¿›åº¦æ¡æ˜¾ç¤º
file_size = os.path.getsize(model_file_path)

# --- è¿›åº¦æ¡å›è°ƒå‡½æ•° ---
def create_callback(encoder_tqdm):
    def callback(monitor):
        # monitor.bytes_read æ˜¯å·²ç»è¯»å–çš„å­—èŠ‚æ•°
        # update éœ€è¦ä¼ å…¥å¢é‡å€¼
        encoder_tqdm.update(monitor.bytes_read - encoder_tqdm.n)
    return callback

# --- ä¸Šä¼ é€»è¾‘ ---
print(f"ğŸš€ å¼€å§‹ä¸Šä¼  {model_file_path} ({file_size / (1024*1024):.2f} MB)...")

with open(model_file_path, "rb") as f:
    # 1. æ„é€ å¤šéƒ¨åˆ†è¡¨å•ç¼–ç å™¨
    encoder = MultipartEncoder(
        fields={'model': (os.path.basename(model_file_path), f, 'application/octet-stream')}
    )
    
    # 2. æ„é€ è¿›åº¦æ¡ï¼ˆtqdmï¼‰
    with tqdm(total=encoder.len, unit='B', unit_scale=True, unit_divisor=1024, desc="Uploading") as bar:
        
        # 3. æ„é€ ç›‘è§†å™¨ï¼Œå¹¶ç»‘å®šå›è°ƒå‡½æ•°
        monitor = MultipartEncoderMonitor(encoder, create_callback(bar))
        
        # 4. å‘é€è¯·æ±‚
        # æ³¨æ„ï¼šè¿™é‡Œçš„ data å¿…é¡»ä¼ å…¥ monitorï¼Œå¹¶ä¸”å¿…é¡»æ‰‹åŠ¨æŒ‡å®š Content-Type
        try:
            response = requests.post(
                url, 
                data=monitor, 
                headers={'Content-Type': monitor.content_type}
            )
            
            # æ‰“å°ç»“æœ
            print("\nâœ… ä¸Šä¼ å®Œæˆï¼æœåŠ¡å™¨å“åº”ï¼š")
            print(json.dumps(response.json(), indent=4))
            
        except Exception as e:
            print(f"\nâŒ ä¸Šä¼ å¤±è´¥: {e}")
